{% load static %}

<header class="site-header">
  <div class="site-header-left">
    <div class="tucked">
      {% if user.is_authenticated %}
        <a class="button" href="{% url 'logout_user' %}">Sign out</a>
        <a class="button" href="{% url 'admin:index' %}">Site Administration</a>
      {% else %}
        <a class="button" href="{% url 'login_user' %}">Sign in</a>
      {% endif %}
    </div>
  </div>

  <div class="site-header-center">
    <div class="title">
      {% if request.path == '/homepage' or request.path == '/' %}
        <span>Wheatley Census</span>
      {% else %}
        <a href="{% url 'homepage' %}">Wheatley Census</a>
      {% endif %}
    </div>

    <nav class="header-nav">
      <a href="{% url 'about' %}">about</a>
      <a href="#search" id="site-search-button">search</a>
    </nav>
  </div>

  <div class="site-header-right">
    <!-- reserved for future use or left empty to balance flex -->
  </div>
</header>

<div class="search-bar">
  <form id="search-bar-form" class="hidden" action="{% url 'search' %}" method="get">
    <select id="search-bar-form-field" name="field">
      <option disabled selected value>Search by…</option>
      <option value="keyword">Keyword</option>
      <option value="location">Location</option>
      <option value="provenance_name">Provenance Name</option>
      <option value="collection">Specific Features</option>
      <option value="year">Year</option>
      <option value="stc">STC / Wing #</option>
      <option value="census_id">WC #</option>
    </select>
    <input id="search-bar-form-text" type="text" name="value" placeholder="Search…" />
    <input id="search-bar-form-submit" type="submit" value="Submit" />
  </form>
</div>

<script>
  utils.get.id('site-search-button').addEventListener('click', function () {
    utils.togglehide.id('search-bar-form');
  });
  $(function() {
    var autofillMap = {
      location: '/autofill/location/',
      provenance_name: '/autofill/provenance/',
      collection: '/autofill/collection/'
    };
    function autofillResponse(field, query, response) {
      fetch(autofillMap[field] + query + '/')
        .then(r => r.json())
        .then(data => response(data.matches));
    }
    $('#search-bar-form-text').autocomplete({
      minLength: 3,
      source: function(req, res) {
        var f = $('#search-bar-form-field').val();
        if (autofillMap[f]) autofillResponse(f, req.term, res);
      },
      select: function(evt, ui) {
        $('#search-bar-form-text').val(ui.item.value);
        $('#search-bar-form').submit();
      }
    });
    $('#search-bar-form-field').change(function() {
      if ($(this).val() === 'collection') {
        $('#search-bar-form-text').autocomplete('search', '   ');
      }
    });
  });
</script>
